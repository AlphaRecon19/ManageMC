<?php class File_ANSI{var $max_x;var $max_y;var $max_history;var $history;var $history_attrs;var $x;var $y;var $old_x;var $old_y;var $attr_row;var $screen;var $attrs;var $foreground;var $background;var $bold;var $underline;var $blink;var $reverse;var $color;var $ansi;function File_ANSI(){$this->setHistory(200);$this->setDimensions(80,24);}function setDimensions($x,$y){$this->max_x=$x-1;$this->max_y=$y-1;$this->x=$this->y=0;$this->history=$this->history_attrs=array();$this->attr_row=array_fill(0,$this->max_x+1,'');$this->screen=array_fill(0,$this->max_y+1,'');$this->attrs=array_fill(0,$this->max_y+1,$this->attr_row);$this->foreground='white';$this->background='black';$this->bold=false;$this->underline=false;$this->blink=false;$this->reverse=false;$this->color=false;$this->ansi='';}function setHistory($history){$this->max_history=$history;}function loadString($source){$this->setDimensions($this->max_x+1,$this->max_y+1);$this->appendString($source);}function appendString($source){for($i=0;$i<strlen($source);$i++){if(strlen($this->ansi)){$this->ansi.=$source[$i];$chr=ord($source[$i]);switch(true){case  $this->ansi=="\x1B=":$this->ansi='';continue2;case  strlen($this->ansi)==2&&$chr>=64&&$chr<=95&&$chr!=ord('['):case  strlen($this->ansi)>2&&$chr>=64&&$chr<=126:break;default:continue2;}switch($this->ansi){case  "\x1B[H":$this->old_x=$this->x;$this->old_y=$this->y;$this->x=$this->y=0;break;case  "\x1B[J":$this->history=array_merge($this->history,array_slice(array_splice($this->screen,$this->y+1),0,$this->old_y));$this->screen=array_merge($this->screen,array_fill($this->y,$this->max_y,''));$this->history_attrs=array_merge($this->history_attrs,array_slice(array_splice($this->attrs,$this->y+1),0,$this->old_y));$this->attrs=array_merge($this->attrs,array_fill($this->y,$this->max_y,$this->attr_row));if(count($this->history)==$this->max_history){array_shift($this->history);array_shift($this->history_attrs);}case  "\x1B[K":$this->screen[$this->y]=substr($this->screen[$this->y],0,$this->x);array_splice($this->attrs[$this->y],$this->x+1);break;case  "\x1B[?1h":break;default:switch(true){case  preg_match('#\x1B\[(\d+);(\d+)H#',$this->ansi,$match):$this->old_x=$this->x;$this->old_y=$this->y;$this->x=$match[2]-1;$this->y=$match[1]-1;break;case  preg_match('#\x1B\[(\d+)C#',$this->ansi,$match):$this->old_x=$this->x;$x=$match[1]-1;break;case  preg_match('#\x1B\[(\d+);(\d+)r#',$this->ansi,$match):break;case  preg_match('#\x1B\[(\d*(?:;\d*)*)m#',$this->ansi,$match):$mods=explode(';',$match[1]);foreach($mods as $mod){switch($mod){case 0:$this->attrs[$this->y][$this->x]='';if($this->bold)$this->attrs[$this->y][$this->x].='</b>';if($this->underline)$this->attrs[$this->y][$this->x].='</underline>';if($this->blink)$this->attrs[$this->y][$this->x].='</blink>';if($this->color)$this->attrs[$this->y][$this->x].='</span>';if($this->reverse){$temp=$this->background;$this->background=$this->foreground;$this->foreground=$temp;}$this->bold=$this->underline=$this->blink=$this->color=$this->reverse=false;break;case 1:if(!$this->bold){$this->attrs[$this->y][$this->x]='<b>';$this->bold=true;}break;case 4:if(!$this->underline){$this->attrs[$this->y][$this->x]='<u>';$this->underline=true;}break;case 5:if(!$this->blink){$this->attrs[$this->y][$this->x]='<blink>';$this->blink=true;}break;case 7:$this->reverse=!$this->reverse;$temp=$this->background;$this->background=$this->foreground;$this->foreground=$temp;$this->attrs[$this->y][$this->x]='<span style="color: '.$this->foreground.'; background: '.$this->background.'">';if($this->color){$this->attrs[$this->y][$this->x]='</span>'.$this->attrs[$this->y][$this->x];}$this->color=true;break;default:$front=&$this->{$this->reverse?'background':'foreground'};$back=&$this->{$this->reverse?'foreground':'background'};switch($mod){case 30:$front='black';break;case 31:$front='red';break;case 32:$front='green';break;case 33:$front='yellow';break;case 34:$front='blue';break;case 35:$front='magenta';break;case 36:$front='cyan';break;case 37:$front='white';break;case 40:$back='black';break;case 41:$back='red';break;case 42:$back='green';break;case 43:$back='yellow';break;case 44:$back='blue';break;case 45:$back='magenta';break;case 46:$back='cyan';break;case 47:$back='white';break;default:user_error('Unsupported attribute: '.$mod);$this->ansi='';break2;}unset($temp);$this->attrs[$this->y][$this->x]='<span style="color: '.$this->foreground.'; background: '.$this->background.'">';if($this->color){$this->attrs[$this->y][$this->x]='</span>'.$this->attrs[$this->y][$this->x];}$this->color=true;}}break;default:echo"{$this->ansi} unsupported\r\n";}}$this->ansi='';continue;}switch($source[$i]){case  "\r":$this->x=0;break;case  "\n":while($this->y>=$this->max_y){$this->history=array_merge($this->history,array(array_shift($this->screen)));$this->screen[]='';$this->history_attrs=array_merge($this->history_attrs,array(array_shift($this->attrs)));$this->attrs[]=$this->attr_row;if(count($this->history)>=$this->max_history){array_shift($this->history);array_shift($this->history_attrs);}$this->y--;}$this->y++;break;case  "\x0F":break;case  "\x1B":$this->ansi.="\x1B";break;default:$this->screen[$this->y]=substr_replace($this->screen[$this->y],$source[$i],$this->x,1);if($this->x>$this->max_x){$this->x=0;$this->y++;}else{$this->x++;}}}}function _getScreen(){$output='';for($i=0;$i<=$this->max_y;$i++){for($j=0;$j<=$this->max_x+1;$j++){if(isset($this->attrs[$i][$j])){$output.=$this->attrs[$i][$j];}if(isset($this->screen[$i][$j])){$output.=htmlspecialchars($this->screen[$i][$j]);}}$output.="\r\n";}return rtrim($output);}function getScreen(){return '<pre style="color: white; background: black" width="'.($this->max_x+1).'">'.$this->_getScreen().'</pre>';}function getHistory(){$scrollback='';for($i=0;$i<count($this->history);$i++){for($j=0;$j<=$this->max_x+1;$j++){if(isset($this->history_attrs[$i][$j])){$scrollback.=$this->history_attrs[$i][$j];}if(isset($this->history[$i][$j])){$scrollback.=htmlspecialchars($this->history[$i][$j]);}}$scrollback.="\r\n";}$scrollback.=$this->_getScreen();return '<pre style="color: white; background: black" width="'.($this->max_x+1).'">'.$scrollback.'</pre>';}}